{% extends "base.html" %}
{% with messages = get_flashed_messages(with_categories=true) %} 
    {% for category, message in messages %}
    {% if category == 'success' %}
        <div class="notification is-success">{{ message }}</div>
    {% else %}
        <div class="notification is-danger">{{ message }}</div>
    {% endif %}
    {% endfor %}
{% endwith %}
{% block content %}
<h1>{{ room.name }}</h1>
<button onclick="goBack()" class="button is-secondary">Back</button>

<div class="room-grid">
    {% for i in range(1, room.rows + 1) %}
        <div class="row">
            {% for j in range(1, room.columns + 1) %}
                {% set desk = desks|selectattr('x', 'equalto', i)|selectattr('y', 'equalto', j)|first %}
                {% if desk %}
                    <div class="grid-item {{ 'reserved' if desk.reserved else 'desk' }}">
                        <button 
                            class="circular-button" 
                            onclick="openModal({{ desk.id }})"
                            reserved_by="{{ desk.reserved_by if desk.reserved else 'Available' }}"
                            start="{{ desk.start if desk.start else ''}}"
                            end="{{ desk.end if desk.end else ''}}"
                            >Desk {{ desk.name }}
                        </button>
                    </div>
                {% else %}
                    <div class="grid-item empty"></div>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
</div>

<!-- Modal HTML -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2>Book Desk <span id="modal-desk-id"></span></h2>
        <form id="bookingForm" method="POST" action="{{ url_for('room') }}?room_id={{room.id}}">
            <input type="hidden" name="desk_id" id="modal-desk-id-input">

            <!-- Start Date-Time Picker -->
            <div>
                <label for="start_datetime">Start Date and Time:</label>
                <input type="datetime-local" id="start_datetime" name="start_datetime" required>
            </div>

            <!-- End Date-Time Picker -->
            <div>
                <label for="end_datetime">End Date and Time:</label>
                <input type="datetime-local" id="end_datetime" name="end_datetime" required>
            </div>

            <div>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>
<script>
    function formatTimestamp(timestamp, timezone) {
        if (!timestamp) return '';
        
        var date = new Date(parseInt(timestamp) * 1000); // Convert from seconds to milliseconds
        
        var options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false, // Use 24-hour format
            timeZone: timezone // Use the timezone passed from Flask
        };
        
        return new Intl.DateTimeFormat('en-GB', options).format(date); // Use the specified timezone and 24-hour format
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.circular-button').forEach(function(button) {
            var startTimestamp = button.getAttribute('start');
            var endTimestamp = button.getAttribute('end');

            button.setAttribute('start', formatTimestamp(startTimestamp));
            button.setAttribute('end', formatTimestamp(endTimestamp));
        });
    });

    function openModal(deskId) {
        // Set the desk ID
        document.getElementById('modal-desk-id').textContent = deskId;
        document.getElementById('modal-desk-id-input').value = deskId;

        // Get the button element to update tooltips
        var button = document.querySelector(`button[onclick="openModal(${deskId})"]`);
        if (button) {
            var startTimestamp = button.getAttribute('start');
            var endTimestamp = button.getAttribute('end');

            // Format timestamps and set data attributes
            button.setAttribute('data-start', formatTimestamp(startTimestamp));
            button.setAttribute('data-end', formatTimestamp(endTimestamp));
        }

        var localDate = new Date();

        // Extract local time components
        var year = localDate.getFullYear();
        var month = String(localDate.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
        var day = String(localDate.getDate()).padStart(2, '0');
        var hours = String(localDate.getHours()).padStart(2, '0');
        var minutes = String(localDate.getMinutes()).padStart(2, '0');
        var seconds = String(localDate.getSeconds()).padStart(2, '0');

        // Format as YYYY-MM-DDTHH:MM
        var startDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

        var endTime = new Date();
        endTime.setUTCHours(23, 59, 0, 0);
        var endDateTime = endTime.toISOString().substring(0, 16); // YYYY-MM-DDTHH:MM

        document.getElementById('start_datetime').value = startDateTime;
        document.getElementById('end_datetime').value = endDateTime;

        // Show the modal
        document.getElementById('bookingModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('bookingModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target === document.getElementById('bookingModal')) {
            closeModal();
        }
    }

    function goBack() {
        window.history.back();
    }
</script>


{% endblock %}
