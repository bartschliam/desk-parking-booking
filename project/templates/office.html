{% extends "base.html" %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %} 
    {% for category, message in messages %}
        {% if category == 'success' %}
            <div class="notification is-success">{{ message }}</div>
        {% else %}
            <div class="notification is-danger">{{ message }}</div>
        {% endif %}
    {% endfor %}
{% endwith %}

<div class="button-container">
    <button class="toggle-button" onclick="showSection('rooms')">Rooms</button>
    <button class="toggle-button" onclick="showSection('parking')">Parking</button>
</div>

<div id="rooms" class="button-grid" style="display: flex;">
    {% for room in rooms %}
        <a href="/room?room_id={{ room.id }}" class="button is-primary is-large">{{ room.name }}</a>
    {% endfor %}
</div>

<div id="parking" class="button-grid" style="display: none;">
    {% for spot in parking_spots %}
        <button 
            class="circular-button" 
            onclick="openParkingModal({{ spot.id }})"
            reserved_by="{{ (bookings | selectattr('spot_id', 'equalto', spot.id) | map(attribute='reserved_by') | list | join(',')) if bookings | selectattr('spot_id', 'equalto', spot.id) else 'Available' }}"
            start="{{ bookings | selectattr('spot_id', 'equalto', spot.id) | map(attribute='start') | list | join(',') }}"
            end="{{ bookings | selectattr('spot_id', 'equalto', spot.id) | map(attribute='end') | list | join(',') }}"
        >
            Parking Spot {{ spot.name }}
        </button>
    {% endfor %}
</div>
<!-- Modal HTML for Parking -->
<div id="parkingModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeParkingModal()">&times;</span>
        <h2>Book Parking Spot <span id="modal-parking-id"></span></h2>
        <form id="parkingForm" method="POST" action="{{ url_for('office') }}">
            <input type="hidden" name="spot_id" id="modal-parking-id-input">
            <input type="hidden" name="timezone" id="user-timezone-parking">

            <!-- Start Date-Time Picker -->
            <div>
                <label for="start-parking">Start Date and Time:</label>
                <input type="datetime-local" id="start-parking" name="start" required>
            </div>

            <!-- End Date-Time Picker -->
            <div>
                <label for="end-parking">End Date and Time:</label>
                <input type="datetime-local" id="end-parking" name="end" required>
            </div>

            <div>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
function showSection(section) {
    document.getElementById('rooms').style.display = section === 'rooms' ? 'flex' : 'none';
    document.getElementById('parking').style.display = section === 'parking' ? 'block' : 'none';
}

// Function to open the parking modal
function openParkingModal(spotId) {
    document.getElementById('modal-parking-id').textContent = spotId;
    document.getElementById('modal-parking-id-input').value = spotId;
    
    var button = document.querySelector(`button[onclick="openParkingModal(${spotId})"]`);
    if (button) {
        var startTimestamp = button.getAttribute('start');
        var endTimestamp = button.getAttribute('end');
        
        button.setAttribute('data-start', formatTimestamp(startTimestamp, getUserTimezone()));
        button.setAttribute('data-end', formatTimestamp(endTimestamp, getUserTimezone()));
    }
    
    var localDate = new Date();
    var year = localDate.getFullYear();
    var month = String(localDate.getMonth() + 1).padStart(2, '0');
    var day = String(localDate.getDate()).padStart(2, '0');
    var hours = String(localDate.getHours()).padStart(2, '0');
    var minutes = String(localDate.getMinutes()).padStart(2, '0');

    var startDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    var endTime = new Date();
    endTime.setUTCHours(23, 59, 0, 0);
    var endDateTime = endTime.toISOString().substring(0, 16);

    document.getElementById('start-parking').value = startDateTime;
    document.getElementById('end-parking').value = endDateTime;

    document.getElementById('parkingModal').style.display = 'block';
}

// Close the parking modal
function closeParkingModal() {
    document.getElementById('parkingModal').style.display = 'none';
}

window.onclick = function(event) {
    if (event.target === document.getElementById('parkingModal')) {
        closeParkingModal();
    }
}
</script>

{% endblock %}